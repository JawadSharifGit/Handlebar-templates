<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Escaping Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background-color: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background-color: #5a6fd8; }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Quote Escaping & HTML Safety Test</h1>
        
        <div class="test-section">
            <h3>Test 1: HTML Attributes with Quotes</h3>
            <textarea id="test1" readonly><!DOCTYPE html>
<html>
<body>
    <div style="font-weight: 700; color: red;">
        <h2 style="margin: 0; padding: 10px;">Hello {{Name}}!</h2>
        <img src="https://example.com/image.jpg" alt="Test Image" style="width: 100px;">
        <p class="highlight" data-value="{{Email}}">Your email: {{Email}}</p>
    </div>
</body>
</html></textarea>
            <button class="btn" onclick="testTemplate(1)">Test HTML Attributes</button>
            <div id="result1" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Nested Quotes and Special Characters</h3>
            <textarea id="test2" readonly><!DOCTYPE html>
<html>
<body>
    <div onclick="alert('Hello {{Name}}!');" style="cursor: pointer;">
        <p>Company: "{{Company}}" - Founded in {{Year}}</p>
        <script>
            var userData = {
                name: "{{htmlEncode Name}}",
                email: "{{htmlEncode Email}}"
            };
        </script>
        <a href="mailto:{{urlEncode Email}}?subject={{urlEncode 'Welcome to {{Company}}'}}">
            Send Email
        </a>
    </div>
</body>
</html></textarea>
            <button class="btn" onclick="testTemplate(2)">Test Nested Quotes</button>
            <div id="result2" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Handlebars Syntax with Quotes</h3>
            <textarea id="test3" readonly><!DOCTYPE html>
<html>
<body>
    {{> header}}
    
    <div style="padding: 20px;">
        {{#ifNotEmpty Name}}
            <h2 style="color: #333; font-family: 'Arial', sans-serif;">
                Welcome "{{titleCase Name}}"!
            </h2>
        {{/ifNotEmpty}}
        
        <p style="font-size: 14px; line-height: 1.6;">
            We are delighted to have you 
        </p>
        
        <div style="text-align: center; margin: 20px 0;">
            <a href="{{url}}" 
               style="background-color: #667eea; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;"
               onclick="gtag('event', 'click', {'event_category': 'email', 'event_label': '{{Company}}'});">
                Get Started
            </a>
        </div>
    </div>
    
    {{> footer}}
</body>
</html></textarea>
            <button class="btn" onclick="testTemplate(3)">Test Handlebars with Quotes</button>
            <div id="result3" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Test 4: JSON and JavaScript Injection</h3>
            <textarea id="test4" readonly><!DOCTYPE html>
<html>
<body>
    <script>
        // Safe way to embed data
        var config = {
            userName: "{{htmlEncode Name}}",
            userEmail: "{{htmlEncode Email}}",
            companyName: "{{htmlEncode Company}}"
        };
        
        // Unsafe way (for testing)
        var unsafeData = "{{Name}}";
        
        console.log("User: " + config.userName);
    </script>
    
    <div data-user='{"name": "{{htmlEncode Name}}", "email": "{{htmlEncode Email}}"}'>
        <p>Safe JSON embedding in data attributes</p>
    </div>
</body>
</html></textarea>
            <button class="btn" onclick="testTemplate(4)">Test JavaScript Safety</button>
            <div id="result4" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const testData = {
            Name: 'John "The Developer" Doe',
            Email: 'john+test@example.com',
            Company: 'Acme & Co. "Solutions"',
            Date: '2025-09-17T12:00:00Z',
            Year: '2020',
            url: 'https://example.com/welcome?ref=email&user=john'
        };

        async function testTemplate(testNumber) {
            const templateContent = document.getElementById(`test${testNumber}`).value;
            const resultDiv = document.getElementById(`result${testNumber}`);
            
            try {
                // First create a template
                const createResponse = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `Quote Test ${testNumber}`,
                        subject: `Test ${testNumber}: "{{Name}}" at {{Company}}`,
                        htmlBody: templateContent
                    })
                });

                if (!createResponse.ok) {
                    throw new Error(`Failed to create template: ${createResponse.statusText}`);
                }

                const template = await createResponse.json();
                
                // Then render it with test data
                const renderResponse = await fetch(`/api/templates/${template.id}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: testData })
                });

                if (!renderResponse.ok) {
                    throw new Error(`Failed to render template: ${renderResponse.statusText}`);
                }

                const result = await renderResponse.json();
                
                resultDiv.className = 'result success';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
<strong>‚úÖ SUCCESS - Template rendered safely!</strong>

<strong>Subject:</strong>
${escapeHtml(result.renderedSubject)}

<strong>HTML Body (first 500 chars):</strong>
${escapeHtml(result.renderedHtmlBody.substring(0, 500))}...

<strong>Analysis:</strong>
- Quotes properly handled: ${result.renderedHtmlBody.includes('"') ? '‚úÖ' : '‚ùå'}
- HTML attributes preserved: ${result.renderedHtmlBody.includes('style=') ? '‚úÖ' : '‚ùå'}
- Handlebars compiled: ${!result.renderedHtmlBody.includes('{{') ? '‚úÖ' : '‚ö†Ô∏è'}
                `;

                // Clean up - delete the test template
                await fetch(`/api/templates/${template.id}`, { method: 'DELETE' });

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
